#  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▄░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░██▌░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░▄▄███▀░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░█████░▄█░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░▄████████▀░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒░░░░░░░░░░░░░░░░░░░░░░░░▄█████████░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░░░░░░░░░░░░░░░░░░▄███████▌░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░░░░░░░░░░░░░░░░▄█████████░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░░░░░░░░░░░░░▄███████████▌░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░░░░░░░▄▄▄▄██████████████▌░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░░░▄▄███████████████████▌░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░░▄██████████████████████▌░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒░░░░░░░░████████████████████████░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒█░░░░░▐██████████▌░▀▀███████████░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▐██░░░▄██████████▌░░░░░░░░░▀██▐█▌░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒██████░█████████ ░░░░░░░░░░▐█▐█▌░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▀▀▀▀░░░██████▀░░░░░░░░░░░░▐█▐█▌░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒░░░░▐█████▌░░░░░░░░░░░░▐█▐█▌░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒░░░░███▀██░░░░░░░░░░░░░█░█▌░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒░▐██░░░██░░░░░░░░▄▄████████▄▄▄▄▄▄▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒▒██▌░░░░█▄░░░░░░▄███████████████████▄▄▄▄▒▒▒▒▒▒▒▒▒▒▒
#  ▒▒▒▒▒▒▒▒▒▐██▒▒░░░██▄▄██████████████████████████████████████
#  ▒▒▒▒▒▒▒▒▒▒▐██▒▒▄███████████████████████████████████████████
#  ▒▒▒▒▒▒▒▒▒▒▄▄███████████████████████████████████████████████
#  ███████████████████████████████████████████████████████████

import asyncio
import websockets
import sqlite3
import json
from server_call import VoiceServer
import threading
from twisted.internet import reactor
from constants import *

userData = {}
userOnline = {}
groups = {}
conn = sqlite3.connect("database/chat.db")
cur = conn.cursor()

def loadUserData():
    global userData, conn, cur
    cur.execute("SELECT userName, userPasswordHash FROM User;")
    userData = {row[0] : row[1] for row in cur.fetchall()}
    print(userData)

def loadGroup():
    global groups, conn, cur
    cur.execute("SELECT groupName, E.userName, userFullName FROM MemberOf E INNER JOIN User U On E.userName = U.userName;")
    for row in cur.fetchall():
        if row[0] not in groups:
            groups[row[0]] = {"members" : [(row[1], row[2])]}
        else:
            groups[row[0]]["members"].append((row[1], row[2]))
    cur.execute("select groupName, groupPassword, groupDes from GroupChat")
    for row in cur.fetchall():
        groups[row[0]]["password"] = row[1]
        groups[row[0]]["groupDes"] = row[2]
        groups[row[0]]["memberCall"] = {}
    print(groups)

def loadDataFor(username, websocket):
    global userOnline, conn, cur, groups

    cur.execute("SELECT userFullName FROM User WHERE userName=?", (username,))
    userRow = cur.fetchone()
    if not userRow:
        return  

    userFullName = userRow[0]

    cur.execute("""
        SELECT M.groupName, groupDes
        FROM MemberOf M INNER JOIN GroupChat G ON M.GroupName = G.GroupName
        WHERE userName=?
    """, (username,))
    groupsRows = cur.fetchall()

    groupsDict = {}

    for groupName, groupDes in groupsRows:
        cur.execute("""
            SELECT mesID, mesContent, date, userName 
            FROM Message
            WHERE groupName = ?
            ORDER BY mesID DESC
        """, (groupName,))
        messages = cur.fetchall()
        
        listMsg = [
            {"mesID": m[0], "mesContent": m[1], "date": m[2], "userName": m[3]} 
            for m in reversed(messages)
        ]

        groupsDict[groupName] = {
            "groupDes" : groupDes,
            "listMsg": listMsg,
            "members" : groups[groupName]["members"],
        }

    if username not in userOnline:
        userOnline[username] = {"userFullName" : userFullName, "ws" : websocket, "groupCall" : None}
        print(userOnline)
    
    return {"username" : username, "userFullName": userFullName, "groups": groupsDict}

def register(fullname, username, password):
    global userData, conn, cur
    userData[username] = password
    cur.execute("Insert into User (userName, userFullName, userPasswordHash) values (?, ?, ?)", (username, fullname, password))
    conn.commit()

def createGroup(groupDes, groupName, groupPassword, userName):
    global groups, conn, cur
    groups[groupName] = {"members" : [(userName, userOnline[userName]["userFullName"])], "password" : groupPassword, "groupDes" : groupDes, "memberCall" : {}}
    cur.execute("INSERT INTO GroupChat (groupName, groupPassword, groupDes, createdBy) values (?, ?, ?, ?)", (groupName, groupPassword, groupDes, userName))
    cur.execute("INSERT INTO MemberOF (userName, groupName) values (?, ?)", (userName, groupName))
    conn.commit()

def joinGroup(groupName, groupPassword, userName):
    global groups, conn, cur
    cur.execute("insert into MemberOf (userName, groupName) values (?, ?)", (userName, groupName))
    conn.commit()
    groups[groupName]["members"].append((userName, userOnline[userName]["userFullName"]))
    cur.execute("""
            SELECT mesID, mesContent, date, userName 
            FROM Message
            WHERE groupName = ?
            ORDER BY mesID DESC
        """, (groupName,))
    messages = cur.fetchall()
    listMsg = [
            {"mesID": m[0], "mesContent": m[1], "date": m[2], "userName": m[3]} 
            for m in reversed(messages)
        ]
    return listMsg

def updateMessageDB(msg):
    global conn, cur
    msgData = (msg["mesContent"], msg["date"], msg["userName"], msg["groupName"])
    cur.execute("INSERT INTO Message (mesContent, date, userName, groupName) VALUES (?, ?, ?, ?)", msgData)
    conn.commit()

def startVoiceServer():
    global groups, userOnline
    print("[Debug] init voice server...")
    voiceServer = VoiceServer(groups, userOnline)
    reactor.listenUDP(PORT_UDP, voiceServer, interface=SERVER_IP)
    print("[Debug] reactor starting...")
    reactor.run(installSignalHandlers=False)
    print("[Debug] reactor ended")


async def handleClient(websocket):
    global groups, userData, userOnline
    print("New client connected.")
    username = None
    try:
        async for msg in websocket:
            data = json.loads(msg)
            print(data)
            if data["type"] == "signUp":
                if data["username"] in userData:
                    responseData = {"type" : "signUp", "status" : False}
                else:
                    register(data["fullname"], data["username"], data["password"])
                    responseData = {"type" : "signUp", "status" : True}
                await websocket.send(json.dumps(responseData))

            if data["type"] == "signIn":
                if data["username"] not in userData:
                    responseData = {"type" : "signIn", "status" : False, "data" : None} 
                elif data["username"] in userOnline:
                    responseData = {"type" : "signIn", "status" : "error", "data" : None} # error happen when user already online and someone try to login
                elif userData[data["username"]] != data["password"]:
                    responseData = {"type" : "signIn", "status" : False, "data" : None} 
                else:
                    username = data["username"]
                    dataOfUser = loadDataFor(data["username"], websocket)
                    responseData = {"type" : "signIn", "status" : True, "data" : dataOfUser}
                await websocket.send(json.dumps(responseData)) 
            
            if data["type"] == "sendMessage":
                updateMessageDB(data["message"])
                responseData = {"type" : "recvMessage", "message" : data["message"]}
                for mem in groups[data["message"]["groupName"]]["members"]:
                    if mem[0] in userOnline:
                        await userOnline[mem[0]]["ws"].send(json.dumps(responseData))

            if data["type"] == "logout":
                if data["username"] in userOnline:
                    responseData = {"type" : "logout", "status" : True}
                    print(f"{data["username"]} log out.")   
                    del userOnline[data["username"]]
                    username = None
                else:
                    responseData = {"type" : "logout", "status" : False}
                await websocket.send(json.dumps(responseData))

            if data["type"] == "createGroup":
                if data["groupName"] in groups:
                    responseData = {"type" : "createGroup", "status" : False, "data" : None}
                else:
                    createGroup(data["groupDes"], data["groupName"], data["groupPassword"], data["username"])
                    responseData = {"type" : "createGroup", "status" : True, "data" : {data["groupName"] : 
                                                                                       {"groupDes" : data["groupDes"], 
                                                                                        "listMsg" : [], 
                                                                                        "members" : groups[data["groupName"]]["members"]
                                                                                        }
                                                                                       }
                                    }
                await websocket.send(json.dumps(responseData))

            if data["type"] == "joinGroup":
                if groups[data["groupName"]]["password"] != data["groupPassword"]:
                    responseData = {"type" : "joinGroup", "status" : False, "data" : None} 
                else:
                    groupName = data["groupName"]
                    listMsg = joinGroup(groupName, data["groupPassword"], data["username"])
                    responseData = {"type" : "joinGroup", "status" : True, "data" : {groupName : 
                                                                                       {"groupDes" : groups[groupName]["groupDes"], 
                                                                                        "listMsg" :listMsg, 
                                                                                        "members" : groups[groupName]["members"]
                                                                                        }
                                                                                       }
                                    }
                await websocket.send(json.dumps(responseData)) 
            
            if data["type"] == "call":
                currentMemberTemp = [(data["username"], userOnline[data["username"]]["userFullName"])]
                for mem in groups[data["groupName"]]["memberCall"]:
                    if mem in userOnline:
                        currentMemberTemp.append((mem, userOnline[mem]["userFullName"]))
                        responseDataTemp = {"type" : "newMemCall", "info" : {data["username"] : userOnline[data["username"]]["userFullName"]}}
                        await userOnline[mem]["ws"].send(json.dumps(responseDataTemp))
                userOnline[data["username"]]["groupCall"] = data["groupName"]
                responseData = {"type" : "call", "status" : True, "username" : data["username"], "groupName" : data["groupName"], "data" : currentMemberTemp}
                await websocket.send(json.dumps(responseData))

            if data["type"] == "leaveCall":
                for mem in groups[data["groupName"]]["memberCall"]:
                    if mem in userOnline:
                        responseDataTemp = {"type" : "memLeaveCall", "info" : data["username"]}
                        await userOnline[mem]["ws"].send(json.dumps(responseDataTemp))
                if data["username"] in groups[data["groupName"]]["memberCall"]:
                    userOnline[data["username"]]["groupCall"] = None
                    del groups[data["groupName"]]["memberCall"][data["username"]]
                responseData = {"type" : "leaveCall", "status" : True}
                await websocket.send(json.dumps(responseData))


    except websockets.exceptions.ConnectionClosed:
        print(f"{username} disconnected.")    
    
    finally:
        if username in userOnline:
            if userOnline[username]["groupCall"] is not None:
                del groups[userOnline[username]["groupCall"]]["memberCall"][username]
            del userOnline[username]

# start the websocket server
async def start_server():
    try:
        loadUserData()
        loadGroup()
        threading.Thread(target=startVoiceServer, daemon=True).start()
        async with websockets.serve(handleClient, SERVER_IP, PORT_TCP):
            print('Websockets Server Started')
            await asyncio.Future()
    finally:
        conn.close()

asyncio.run(start_server())